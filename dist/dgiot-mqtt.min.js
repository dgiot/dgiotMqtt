/*!
 * dgiot-mqtt.js v1.0.0
 * (c) 2021/9/10  18:11:16 h7ml(h7ml@qq.com)
 * Released under the MIT License.
 */
!function(o){"use strict";var t=require("../utils/index.js"),e=require("@dgiot/dgiotbus"),n=require("../utils/iotMqtt"),c=require("../store/index.js"),s=require("moment"),i=t.Map2Json,r=t.getMqttEventId,l=!0;console.log("dgiotBus",e),console.log("dgiot_mqtt");var a={name:"dgiotmqtt",data:function(){return{consoleTale:[],reconnectNum:0,isReconnect:l,maxReconnectNum:100,MapTopic:new Map}},computed:{mapTopic:function(){return c.getters["mqtt/mapTopic"]}},created:function(){var o=this;e.$off("".concat(r("subscribe"))),e.$on("".concat(r("subscribe")),(function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;console.groupCollapsed("%ciotMqtt subscribe arg","color:#009a61; font-size: 28px; font-weight: 300"),console.table(t),console.groupEnd(),o.subscribe(t,e)}))},mounted:function(){},methods:{connectCheckTopic:function(o){for(var t in o)o[t].endtime>Number(s().format("x"))?this.subscribe({topickey:t,topic:o[t].topic,ttl:o[t].endtime-Number(s().format("x"))}):this.unsubscribe(t,o[t].topic)},busSendMsg:function(o,t,n){var c=Number(s().format("x")),r=i(this.mapTopic);for(var l in r){if(this.checkTopic(r[l].topic,o)){var a={topic:o,msg:t,Message:n,timestamp:s().format("x")};e.$emit("".concat(l),a),console.groupCollapsed("%ciotMqtt SendMsg payloadString","color:#009a61; font-size: 28px; font-weight: 300"),console.groupEnd(),console.table({topic:o,topicKey:l,args:a})}Number(r[l].endtime)<c&&this.unsubscribe(r[l].topic,l)}console.groupCollapsed("%ciotMqtt busSendMsg payloadString","color:#009a61; font-size: 28px; font-weight: 300"),console.warn("%c%s","font-size: 24px;",t),console.groupEnd()},checkTopic:function(o,t){var e=t.length<o.length?t:o;for(var n in e){if("#"==o[n]||o==t)return!0;if("+"!=o[n]&&o[n]!=o[n])return!1}},initMqtt:function(){var o=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t=_.merge(t,{time:s(new Date).format("YYYY-MM-DD HH:mm:ss.SSS")});var e=this;if(_.isEmpty(t.id))return console.info("%c%s","color: green;font-size: 24px;","options 为空 不连接mqtt"),!1;console.groupCollapsed("%ciotMqtt connect msg","color:#009a61; font-size: 28px; font-weight: 300"),console.table(t),console.groupEnd(),n.init({id:t.id,ip:t.ip,port:t.port,userName:t.userName,passWord:t.passWord,success:function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"clientId为".concat(t.id,",iotMqtt连接成功");e.mqttSuccess(n),_.isEmpty(e.mapTopic)||e.connectCheckTopic(i(o.mapTopic))},error:function(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"iotMqtt接失败,自动重连";e.mqttError(o)},connectLost:function(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"iotMqtt连接丢失";e.mqttError(o)},onMessage:function(o){e.onMessage(o)}})},mqttSuccess:function(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"success";console.groupCollapsed("%ciotMqtt connection succeeded","color:#009a61; font-size: 28px; font-weight: 300"),console.info("%c%s","color: green;font-size: 24px;",o),console.groupEnd()},mqttError:function(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error",t=this;console.groupCollapsed("%ciotMqtt Connection failed","color:#009a61; font-size: 28px; font-weight: 300"),console.error("%c%s","color: red;font-size: 24px;",o),console.groupEnd(),this.isReconnect?t.reconnect():console.info("reconnect 为true","不自動重連")},connectLost:function(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"connectLost";console.groupCollapsed("%ciotMqtt Connection lost","color:#009a61; font-size: 28px; font-weight: 300"),console.error("%c%s","color: red;font-size: 24px;",o),console.groupEnd()},onMessage:function(o){var t=o.destinationName,e=void 0===t?"destinationName":t,n=o.duplicate,c=void 0===n?"duplicate":n,s=o.payloadBytes,i=void 0===s?"payloadBytes":s,r=o.payloadString,l=void 0===r?"payloadString":r,a=o.qos,p=void 0===a?0:a,u=o.retained,d={destinationName:e,duplicate:c,payloadBytes:i,payloadString:l,qos:p,retained:void 0===u?"retained":u};this.consoleTale.push(d),console.groupCollapsed("%ciotMqtt onMessage","color:#009a61; font-size: 28px; font-weight: 300"),console.table(this.consoleTale),console.groupEnd(),this.busSendMsg(e,l,o)},subscribe:function(o){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e=o.topicKey,i=o.topic,r=o.ttl,l=this,a=Number(s().format("x"))+r;l.MapTopic.set(e,{topic:i,endtime:a}),c.dispatch("mqttMsg/setMapTopic",l.MapTopic),_.isEmpty(i)?console.error("no topic"):(n.subscribe(i,t),console.groupCollapsed("%ciotMqtt subscribe","color:#009a61; font-size: 28px; font-weight: 300"),console.table(o),console.groupEnd())},unsubscribe:function(o,t){n.unsubscribe(t);var e=this.mapTopic;_.isEmpty(e)||(e.delete(o),c.dispatch("mqttMsg/setMapTopic",e)),console.info("%c%s","color: green;font-size: 24px;",e),console.groupCollapsed("%ciotMqtt unsubscribe","color:#009a61; font-size: 28px; font-weight: 300"),console.info("%c%s","color: green;font-size: 24px;","unsubscribe: topic"+t),console.groupEnd()},reconnect:function(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"自动重连mqtt",t=this;t.reconnectNum++;var e=t.maxReconnectNum<4?4:t.maxReconnectNum;t.reconnectNum<e?(n.reconnect(),console.groupCollapsed("%ciotMqtt reconnect","color:#009a61; font-size: 28px; font-weight: 300"),console.log("%c%s","color: black; font-size: 24px;","当前重连次数："+t.reconnectNum+"次"+o),console.groupEnd()):console.error("%c%s","color: black;font-size: 24px;","当前重连次数大于"+e+"次,不再自动重连,重连第"+t.reconnectNum+"次")},sendMessage:function(o,t){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,c=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(_.isEmpty(t))return console.groupCollapsed("%csendMsg","color:#009a61; font-size: 28px; font-weight: 300"),console.error(o,t,"没有发送消息的内容"),void console.groupEnd();try{n.sendMessage(o,t,e,c),console.groupCollapsed("%csendMsg","color:#009a61; font-size: 28px; font-weight: 300"),console.log(o,t),console.groupEnd()}catch(o){console.log("error",o),console.groupCollapsed("%ciotMqtt sendMessage error","color:#009a61; font-size: 28px; font-weight: 300"),console.warn("%c%s","color: red;font-size: 24px;",o),console.groupEnd()}}}};window.dgiotmqtt=a;var p=Object.freeze({__proto__:null,default:a});o.dgiotmqtt=p,Object.defineProperty(o,"__esModule",{value:!0})}(this["dgiot-mqtt"]=this["dgiot-mqtt"]||{});
//# sourceMappingURL=dgiot-mqtt.min.js.map
